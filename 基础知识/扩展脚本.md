
// Clash Verge - å…¨å±€æ‰©å±•è„šæœ¬ï¼ˆScriptï¼‰

// ç›®æ ‡ï¼šVSCode + Python èµ° â€œæœºåœºèŠ‚ç‚¹(ç¬¬ä¸€è·³) -> ç¾å›½é™æ€IP(ç¬¬äºŒè·³)â€ï¼›å…¶å®ƒè½¯ä»¶ä»æŒ‰åŸ rules

  

function main(config) {

Â  // ========= â‘  åªéœ€è¦æ”¹è¿™é‡Œï¼šä½ çš„ç¾å›½é™æ€IP =========

Â  const staticProxy = {

Â  Â  name: "ğŸ‡ºğŸ‡¸ ç¾å›½é™æ€IP",

Â  Â  type: "socks5", Â  Â  Â  Â // å¦‚æœå•†å®¶ç»™çš„æ˜¯ httpï¼Œå°±æ”¹æˆ "http"

Â  Â  server: "50", Â  Â  // æ”¹æˆä½ çš„IP

Â  Â  port: 44, Â  Â  Â  Â  Â  // æ”¹æˆç«¯å£

Â  Â  username: "la", Â  Â  Â // æ²¡æœ‰ç”¨æˆ·åå¯†ç å°±åˆ æ‰username/password ä¸¤è¡Œ

Â  Â  password: "pgEF",

Â  Â  udp: true

Â  };

  

Â  // ä½ æ–‡ä»¶é‡Œçš„æœºåœºé€‰æ‹©ç»„åå°±æ˜¯è¿™ä¸ªï¼šğŸ”° é€‰æ‹©èŠ‚ç‚¹ Â :contentReference[oaicite:1]{index=1}

Â  const airportGroupName = "ğŸ”° é€‰æ‹©èŠ‚ç‚¹";

Â  // ===============================================

  

Â  const finalGroupName = "â›“ï¸ VSCode+Python é™æ€é“¾";

Â  const relayPrefix = "â›“ï¸ chain/";

  

Â  const isArr = (x) => Array.isArray(x);

  

Â  function upsertByName(arr, obj) {

Â  Â  if (!isArr(arr)) arr = [];

Â  Â  const i = arr.findIndex((x) => x && x.name === obj.name);

Â  Â  if (i >= 0) arr[i] = obj;

Â  Â  else arr.push(obj);

Â  Â  return arr;

Â  }

  

Â  function removeGroupsByPredicate(groups, pred) {

Â  Â  if (!isArr(groups)) return [];

Â  Â  return groups.filter((g) => g && !pred(g));

Â  }

  

Â  function removeRulesExact(rules, list) {

Â  Â  if (!isArr(rules)) return [];

Â  Â  const s = new Set(list);

Â  Â  return rules.filter((r) => !s.has(r));

Â  }

  

Â  function cleanName(s) {

Â  Â  return String(s || "").replace(/\s+/g, " ").trim();

Â  }

  

Â  // 0) åˆå§‹åŒ–

Â  if (!config) config = {};

Â  if (!isArr(config.proxies)) config.proxies = [];

Â  if (!isArr(config["proxy-groups"])) config["proxy-groups"] = [];

Â  if (!isArr(config.rules)) config.rules = [];

  

Â  // 1) åŠ å…¥/æ›´æ–°ä½ çš„ç¾å›½é™æ€IPåˆ° proxies

Â  config.proxies = upsertByName(config.proxies, staticProxy);

  

Â  // 2) æ‰¾åˆ°æœºåœºé€‰æ‹©ç»„

Â  const airportGroup = config["proxy-groups"].find((g) => g && g.name === airportGroupName);

Â  if (!airportGroup || !isArr(airportGroup.proxies) || airportGroup.proxies.length === 0) {

Â  Â  // æ‰¾ä¸åˆ°å°±ä¸æ”¹ï¼Œé¿å…ç ´åé…ç½®

Â  Â  return config;

Â  }

  

Â  // 3) ä»æœºåœºç»„é‡Œæ‹¿â€œç¬¬ä¸€è·³å€™é€‰èŠ‚ç‚¹â€

Â  // ä½ çš„æœºåœºç»„é‡Œæœ‰ DIRECTï¼ˆæ–‡ä»¶é‡Œèƒ½çœ‹åˆ°ï¼‰:contentReference[oaicite:2]{index=2}

Â  // è¿™é‡Œä¼šæŠŠ DIRECT/REJECT æ’é™¤æ‰

const firstHopNodes = airportGroup.proxies

Â  .filter((p) => typeof p === "string")

Â  .filter((p) => /é¦™æ¸¯|æ–°åŠ å¡/.test(p));

  

Â  // 4) ä¸ºæ¯ä¸ªç¬¬ä¸€è·³èŠ‚ç‚¹ç”Ÿæˆä¸€ä¸ª relayï¼š (è¯¥èŠ‚ç‚¹ -> ç¾å›½é™æ€IP)

Â  const relayGroups = [];

Â  const relayNames = [];

  

Â  for (const hop of firstHopNodes) {

Â  Â  const hopName = cleanName(hop);

Â  Â  const relayName = cleanName(`${relayPrefix}${hopName}`);

Â  Â  relayGroups.push({

Â  Â  Â  name: relayName,

Â  Â  Â  type: "relay",

Â  Â  Â  proxies: [hopName, staticProxy.name]

Â  Â  });

Â  Â  relayNames.push(relayName);

Â  }

  

Â  // 5) æœ€ç»ˆç»™ VSCode/Python ç”¨çš„ç»„ï¼šselectï¼ˆé€‰æ‹©å“ªæ¡é“¾=é€‰æ‹©ç¬¬ä¸€è·³ï¼‰

Â  const finalGroup = {

Â  Â  name: finalGroupName,

Â  Â  type: "select",

Â  Â  proxies: [

Â  Â  Â  ...relayNames,

Â  Â  Â  airportGroupName, Â  // å¤‡ç”¨ï¼šç›´æ¥èµ°æœºåœºï¼ˆä¸å¥—é™æ€IPï¼‰

Â  Â  Â  staticProxy.name Â  Â // å¤‡ç”¨ï¼šç›´è¿é™æ€IPï¼ˆæ’éšœç”¨ï¼Œä¸å»ºè®®å¸¸ç”¨ï¼‰

Â  Â  ]

Â  };

  

Â  // 6) æ¸…ç†æ—§çš„åŒåç»„ & æ—§çš„ relayPrefix ç»„ï¼Œé¿å…è®¢é˜…æ›´æ–°åè¶Šå è¶Šå¤š

Â  config["proxy-groups"] = removeGroupsByPredicate(

Â  Â  config["proxy-groups"],

Â  Â  (g) => g.name === finalGroupName || String(g.name || "").startsWith(relayPrefix)

Â  );

  

Â  // æŠŠæ–°ç»„æ”¾å‰é¢ï¼ŒUIé‡Œå¥½æ‰¾

Â  config["proxy-groups"].unshift(finalGroup, ...relayGroups);

  

Â  // 7) åªç»™ VSCode + Python æ’å…¥è¿›ç¨‹è§„åˆ™ï¼ˆæ’åˆ° rules æœ€å‰é¢ï¼Œä¼˜å…ˆçº§æœ€é«˜ï¼‰

Â  const myRules = [

Â  Â  `PROCESS-NAME,code.exe,${finalGroupName}`,

Â  Â  `PROCESS-NAME,Code.exe,${finalGroupName}`,

Â  Â  `PROCESS-NAME,python.exe,${finalGroupName}`,

Â  Â  `PROCESS-NAME,pythonw.exe,${finalGroupName}`

Â  ];

  

Â  config.rules = removeRulesExact(config.rules, myRules);

Â  config.rules.unshift(...myRules);

  

Â  return config;

}